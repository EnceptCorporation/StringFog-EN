
# StringFog
An Android plug-in tool that automatically encrypts strings in dex/aar/jar files. As the name suggests, it adds a layer of haze to strings, making it difficult for people to see their true colors.

- Support java/kotlin.
- Support the encryption of apk generated by app packaging.
- Support encryption of library files such as aar and jar.
- Support independent extension of encryption and decryption algorithms.
- Support for configuring optional code encryption.
- Full Gradle automation integration.
- InstantRun is not supported.

### Explain

![](https://github.com/MegatronKing/StringFog/blob/master/assets/flow.png)<br>


### Encryption Example: 

- Before encryption:
```
String a = "This is a normal string!";
```

- After Encryption:
```
String a = StringFog.decrypt(new byte[]{-113, 71...}, new byte[]{-23, 53});

```

- Runtime:
```
decrypt: new byte[]{-113, 71...} => "This is a string!"
```

### obfuscate
StringFog does not conflict with obfuscation at all, and there is no need to configure anti-obfuscation. In fact, StringFog with obfuscation will be better!

### Usage:
Since the gradle plugin is developed, it is very simple to integrate and will not affect the packaged configuration. The plugin has been uploaded to MavenCentral, and you can directly refer to the dependencies.

<br>

##### 1. Introduce plugin dependencies in the root directory `build.gradle`:
```
buildscript {
    repositories {
        google()
        mavenCentral()
    }
    
    dependencies {
        ...
        classpath 'com.github.megatronking.stringfog:gradle-plugin:4.0.0'
        // Select the encryption and decryption algorithm library, the xor algorithm is implemented by default, or you can use your own encryption and decryption library.
        classpath 'com.github.megatronking.stringfog:xor:4.0.0'
    }
}
```

<br>

##### 2、Add library dependency at `build.gradle` of the app or library:
```
dependencies {
      ...
      // This should be consistent with the encryption and decryption algorithm library selected above, which is used for runtime decryption.
      implementation 'com.github.megatronking.stringfog:xor:4.0.0'
}
```

<br>

##### 3. Configure the plugin in the `build.gradle` of the app or library.
```
apply plugin: 'stringfog'

// Import RandomKeyGenerator class, if you don't use RandomKeyGenerator, you can delete this line
import com.github.megatronking.stringfog.plugin.kg.RandomKeyGenerator

stringfog {

    // Required: The implementation class path of the encryption and decryption library must be consistent with the encryption and decryption algorithm    library configured above.
    implementation 'com.github.megatronking.stringfog.xor.StringFogImpl'

    // Optional: Encryption switch, enabled by default.
    enable true

    // Optional: Specify the path of the code package to be encrypted. Multiple paths can be configured. If not specified, all of them will be encrypted by default.
    fogPackages = ['com.xxx.xxx']
    
    // Optional: Specify the key generator, and use a random key of length 8 by default (each string has a different random key).
    // You can also specify a fixed key: HardCodeKeyGenerator("This is a key")
    kg new RandomKeyGenerator()
    
    // Optional (new in version 4.0): used to control the existence form of the encrypted string in the bytecode, the default is bytes, you can change it to "mode bytes" OR "mode base64".
    mode bytes
}
```


<br><br>

## Extra Steps:

#### Annotation Anti-Encryption
If developers have classes that do not need automatic encryption, they can use the annotation StringFogIgnore to ignore:
```
@StringFogIgnore
public class Test {
    ...
}
```

#### Implementation of custom encryption and decryption algorithm:
Implement the IStringFog interface, refer to the implementation of the xor algorithm under the stringfog-ext directory.
Note that some algorithms vary on different platforms and may not decrypt correctly at runtime. How to integrate, please refer to the example below!
```

<br>

public final class StringFogImpl implements IStringFog {

    @Override
    public byte[] encrypt(String data, byte[] key) {
        // custom encryption
    }

    @Override
    public String decrypt(byte[] data, byte[] key) {
        // Custom decryption
    }

    @Override
    public boolean shouldFog(String data) {
        // Control whether the specified string is encrypted.
        // It is recommended to filter out unimportant or too long strings.
        return true;
    }

}

```

#### custom key generator
Implement the IKeyGenerator interface, refer to the implementation of RandomKeyGenerator.

#### Mapping file
The encrypted and decrypted string plaintext and ciphertext will automatically generate a mapping mapping file, located in outputs/mapping/stringfog.txt.

<br>

## Examples Apps:
- Default encryption and decryption algorithm integration, refer to: [sample1](https://github.com/MegatronKing/StringFog-Sample1)
- Custom encryption and decryption algorithm integration, refer to: [sample2](https://github.com/MegatronKing/StringFog-Sample2)

## Changelog

### v4.0.0 (Latest Version)
- Use ASM7 to support Android 12。
- support AGP(Android Gradle Plugin) 7.x Version。
- The StringFogMode option is added to the DSL, which is used to control the existence form of the encrypted string in the bytecode. It supports two modes: base64 and bytes, and base64 is used by default.
     - base64 mode: use base64 encoding for the encrypted byte sequence of the string, the behavior is the same as 1.x and 2.x versions.
     - bytes mode: The encrypted byte sequence of the string is directly displayed in the bytecode, the behavior is the same as that of version 3.x.

### v3.0.0
- Ciphertext no longer exists as String, instead it is a direct byte array, thanks to PR #50.
- Refactored public API related code (incompatible with historical versions).
- Removed AES encryption implementation, which is of little significance considering bugs and performance issues.
- The xor algorithm removes base64 encoding.
- The fixed encrypted string key is changed to a random key, and the IKeyGenerator interface is provided to support custom implementation.
- The ASM library that the plugin depends on is upgraded from 5.x to 9.2.

### v2.2.1
- Fix the error report caused by the module-info class.

### v2.2.0
- Support AGP (Android Gradle Plugin) 3.3.0+ version.

### v2.1.0
- Fix kotlin packaging bug

### v2.0.1
- Add implementation custom algorithm implementation class detailed error message.

### v2.0.0
- Modify the gradle configuration (the implementation must be configured to specify the algorithm implementation).
- Fix compilation failure for large strings.
- Added custom encryption and decryption algorithm extension.
- Added the generation of mapping table file.

### v1.4.1
- Fix ZipException compilation error when using Java 8

### v1.4.0
- Added a configuration item for specifying package name encryption: fogPackages.
- Remove configuration items that specify unencrypted package names: exclude.

### v1.3.0
- Fix the bug of gradle 3.0+ compilation error.

### v1.2.2
- Fix the bug of error reporting after packaging under Windows.

### v1.2.1
- Fix the bug of file separator under windows.
- Fixed the bug that the applicationId and packageName were inconsistent and could not be compiled.
- Optimized functions, no need to manually exclude libraries that already use StringFog.

### v1.2.0
- Support use in library, each library can use different key.
- Support exclude specified package name without encryption.
- Fix some known bugs.


--------

    Copyright (C) 2022, Megatron King.
    Developed & Translated to English By Encept LTD Company.

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
